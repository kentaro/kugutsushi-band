#!/bin/bash
# start — kugutsushi-band マスター起動スクリプト
# 1. lattice (SuperCollider) 起動
# 2. AI 傀儡師起動
# 3. MIDI ルーティング設定 (全ポートが揃ってから)

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
REPO_DIR="$SCRIPT_DIR/.."
LATTICE_DIR="$HOME/src/github.com/kentaro/lattice"

# ─── 既存プロセスをクリーンアップ ─────────────────────────────────────────
pkill -f puppet.py 2>/dev/null || true
pkill -f drummer.py 2>/dev/null || true
pkill sclang 2>/dev/null || true
pkill jackd 2>/dev/null || true
echo stop > /tmp/drum.cmd 2>/dev/null || true
sleep 1

# ─── lattice が存在するか確認 ─────────────────────────────────────────────
if [ ! -f "$LATTICE_DIR/bin/lattice" ]; then
    echo "[start] ERROR: lattice not found at $LATTICE_DIR"
    echo "  Clone it first: git clone git@github.com:kentaro/lattice.git $LATTICE_DIR"
    exit 1
fi

# ─── 1. lattice (SuperCollider) をバックグラウンドで起動 ──────────────────
echo "[start] Starting lattice (SuperCollider)..."
bash "$LATTICE_DIR/bin/lattice" &
LATTICE_PID=$!
echo "[start] lattice PID: $LATTICE_PID"

echo "[start] Waiting for SuperCollider to boot (10s)..."
sleep 10

# ─── 2. AI 傀儡師を起動 (仮想MIDIポート "Kugutsushi" を作る) ─────────────
echo "[start] Starting AI puppet (kugutsushi)..."
PUPPET_DIR="$REPO_DIR/kugutsushi"

if [ -f "$PUPPET_DIR/.venv/bin/python" ]; then
    "$PUPPET_DIR/.venv/bin/python" "$PUPPET_DIR/puppet.py" &
elif command -v uv &>/dev/null; then
    (cd "$PUPPET_DIR" && uv run python puppet.py) &
else
    python3 "$PUPPET_DIR/puppet.py" &
fi
PUPPET_PID=$!
echo "[start] puppet PID: $PUPPET_PID"

# ─── 3. ドラムデーモンを起動 ──────────────────────────────────────────────
echo "[start] Starting drummer daemon..."
if [ -f "$PUPPET_DIR/.venv/bin/python" ]; then
    "$PUPPET_DIR/.venv/bin/python" "$PUPPET_DIR/drummer.py" &
else
    python3 "$PUPPET_DIR/drummer.py" &
fi
DRUMMER_PID=$!
echo "[start] drummer PID: $DRUMMER_PID"

# MIDIポートが揃うまで待つ
echo "[start] Waiting for MIDI ports (3s)..."
sleep 3

# ─── 4. MIDI ルーティング (全ポートが揃った状態で接続) ────────────────────
echo "[start] Configuring MIDI routing..."
bash "$REPO_DIR/routing/connect.sh"

echo ""
echo "╔══════════════════════════════════════════════╗"
echo "║  kugutsushi-band ready                       ║"
echo "║  echo start > /tmp/drum.cmd  → ドラム開始   ║"
echo "║  echo stop  > /tmp/drum.cmd  → ドラム停止   ║"
echo "║  Ctrl+C to stop all                          ║"
echo "╚══════════════════════════════════════════════╝"

# Ctrl+C で全プロセスを止める
trap "echo '[start] Stopping...'; kill $LATTICE_PID $PUPPET_PID $DRUMMER_PID 2>/dev/null; exit 0" INT TERM

wait
